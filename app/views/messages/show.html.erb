<div class="mediation-container">
  <%       
    tenant_screening = ScreeningQuestion.find_by(ScreeningID: @mediation.TenantScreeningID, deleted_at: nil)
    landlord_screening = ScreeningQuestion.find_by(ScreeningID: @mediation.LandlordScreeningID, deleted_at: nil)
  %>
  <% if @mediation&.deleted_at.nil? && @message_string&.deleted_at.nil? %>
    <% mediator_assigned = @mediation&.MediatorRequested && @mediation&.MediatorAssigned %>
    <% screenings_flagged = tenant_screening&.flagged == true || landlord_screening&.flagged == true %>

    <% if mediator_assigned && !screenings_flagged %>
      <%# Moved to conversation details panel %>
    <% end %>
    <div class="chat-page-wrapper">
      <div class="conversation-info-trigger">
        <button type="button" class="conversation-cta conversation-cta--info" data-conversation-info-toggle>
          <span class="conversation-cta__icon" aria-hidden="true"><i class="fa-solid fa-circle-info"></i></span>
          <span class="conversation-cta__label">Conversation details</span>
          <span class="conversation-cta__chevron" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
        </button>
      </div>

      <div class="conversation-info-panel" data-conversation-info-panel hidden role="dialog" aria-modal="true">
        <div class="conversation-info-card">
          <div class="conversation-info-card__header">
            <h3>Conversation details</h3>
            <button type="button" class="info-close-btn" data-conversation-info-close aria-label="Close conversation details">
              <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
          </div>
          <div class="conversation-info-card__body">
            <% 
               other_party_role = @user.Role == "Tenant" ? "Landlord" : "Tenant" 
               is_mediator = @user.Role == "Mediator"
            %>
            
            <% if mediator_assigned && !screenings_flagged %>
              <div class="info-box info-box--mediator">
                <h4>Mediation Active</h4>
                <% if is_mediator %>
                  <p>You're now part of the primary conversation. Messages you send here are visible to both the tenant and landlord.</p>
                <% else %>
                  <p>A mediator has joined the conversation. Messages you send here are visible to both the <%= other_party_role.downcase %> and the mediator.</p>
                <% end %>
              </div>
            <% elsif !is_mediator %>
              <div class="info-box info-box--info">
                <h4>Negotiation Active</h4>
                <p>This is a mediation conversation with your <%= other_party_role.downcase %>.</p>
              </div>
            <% end %>

            <table class="info-table">
              <tr>
                <th>Address</th>
                <td><%= @mediation.tenant.TenantAddress.presence || "N/A" %></td>
              </tr>
              <% if @user.Role == "Tenant" %>
                <tr>
                  <th>Landlord Name</th>
                  <td><%= @mediation.landlord.FName %> <%= @mediation.landlord.LName %></td>
                </tr>
                <tr>
                  <th>Landlord Email</th>
                  <td><%= @mediation.landlord.Email %></td>
                </tr>
                <% if (mediator = @mediation&.mediator) %>
                  <tr>
                    <th>Mediator Name</th>
                    <td><%= [mediator.FName, mediator.LName].compact.join(" ").squeeze(" ").strip.presence || mediator.Email %></td>
                  </tr>
                  <tr>
                    <th>Mediator Email</th>
                    <td><%= mediator.Email %></td>
                  </tr>
                <% end %>
              <% elsif @user.Role == "Landlord" %>
                <tr>
                  <th>Tenant Name</th>
                  <td><%= @mediation.tenant.FName %> <%= @mediation.tenant.LName %></td>
                </tr>
                <tr>
                  <th>Tenant Email</th>
                  <td><%= @mediation.tenant.Email %></td>
                </tr>
                <% if (mediator = @mediation&.mediator) %>
                  <tr>
                    <th>Mediator Name</th>
                    <td><%= [mediator.FName, mediator.LName].compact.join(" ").squeeze(" ").strip.presence || mediator.Email %></td>
                  </tr>
                  <tr>
                    <th>Mediator Email</th>
                    <td><%= mediator.Email %></td>
                  </tr>
                <% end %>
              <% elsif @user.Role == "Mediator" %>
                <tr>
                  <th>Tenant Name</th>
                  <td><%= @mediation.tenant.FName %> <%= @mediation.tenant.LName %></td>
                </tr>
                <tr>
                  <th>Tenant Email</th>
                  <td><%= @mediation.tenant.Email %></td>
                </tr>
                <tr>
                  <th>Tenant Phone</th>
                  <td><%= @mediation.tenant.PhoneNumber.presence || "N/A" %></td>
                </tr>
                <tr>
                  <th>Landlord Name</th>
                  <td><%= @mediation.landlord.FName %> <%= @mediation.landlord.LName %></td>
                </tr>
                <tr>
                  <th>Landlord Email</th>
                  <td><%= @mediation.landlord.Email %></td>
                </tr>
                <tr>
                  <th>Landlord Phone</th>
                  <td><%= @mediation.landlord.PhoneNumber.presence || "N/A" %></td>
                </tr>
              <% end %>
            </table>
          </div>
        </div>
      </div>
    </div>
    <% if screenings_flagged %>
      <% composer_disabled_reason = "Messaging is paused while an administrator reviews the flagged screening responses." %>
      <p class="alert alert-warning">One of the party's screening questions has been flagged and is under review by an administrator. Please wait before continuing mediation.</p>
      <div class="message-page-container chat-layout">
        <section class="chat-panel-wrapper">
          <%= render 'negotiation_chatbox',
                participants: @conversation_participants,
                current_user: @user,
                broadcast_enabled: @broadcast_enabled,
                placeholder_text: @message_placeholder,
                composer_enabled: false,
                composer_disabled_reason: composer_disabled_reason %>
        </section>
        <div class="chat-actions-column">
          <%= render 'actions' %>
        </div>
      </div>
    <% else %>
      <!-- Unified Chatbox and Actions Side-by-side Layout -->
      <div class="message-page-container chat-layout">
        <section class="chat-panel-wrapper">
          <%= render 'negotiation_chatbox',
                participants: @conversation_participants,
                current_user: @user,
                broadcast_enabled: @broadcast_enabled,
                placeholder_text: @message_placeholder %>
        </section>
        <div class="chat-actions-column">
          <%= render 'actions' %>
        </div>
      </div>
    <% end %>
  <% else %>
    <%= render "good_faith_prompt", mediation: @mediation, user: @user %>
  <% end %>
</div>
