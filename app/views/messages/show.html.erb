<div class="mediation-container">
  <%       
    tenant_screening = ScreeningQuestion.find_by(ScreeningID: @mediation.TenantScreeningID, deleted_at: nil)
    landlord_screening = ScreeningQuestion.find_by(ScreeningID: @mediation.LandlordScreeningID, deleted_at: nil)
  %>
  <% if @mediation&.deleted_at.nil? && @message_string&.deleted_at.nil? %>
    <% if @mediation&.MediatorRequested && @mediation&.MediatorAssigned && (tenant_screening&.flagged != true && landlord_screening&.flagged != true) %>
      <h1>Mediation Conversation</h1>
      <p>
        A mediator has been requested and assigned to this case. <br>
        You are now communicating with a neutral third-party mediator to help resolve the issue.
      </p>
    <% elsif @mediation&.MediatorRequested && @mediation&.MediatorAssigned && (tenant_screening&.flagged == true || landlord_screening&.flagged == true) %>
      <h1>Mediation Conversation</h1>
    <% else %>
      <h1>
        Negotiation with <%= @user.Role == "Tenant" ? "Landlord" : "Tenant" %>
      </h1>
    <% end %>
    <div class="chat-page-wrapper">
      <div class="conversation-info-trigger">
        <button type="button" class="conversation-cta conversation-cta--info" data-conversation-info-toggle>
          <span class="conversation-cta__icon" aria-hidden="true"><i class="fa-solid fa-circle-info"></i></span>
          <span class="conversation-cta__label">Conversation details</span>
          <span class="conversation-cta__chevron" aria-hidden="true"><i class="fa-solid fa-chevron-right"></i></span>
        </button>
      </div>

      <div class="conversation-info-panel" data-conversation-info-panel hidden role="dialog" aria-modal="true">
        <div class="conversation-info-card">
          <div class="conversation-info-card__header">
            <h3>Conversation details</h3>
            <button type="button" class="info-close-btn" data-conversation-info-close aria-label="Close conversation details">
              <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
          </div>
          <div class="conversation-info-card__body">
            <table class="info-table">
              <tr>
                <th>Address</th>
                <td><%= @mediation.tenant.TenantAddress.presence || "N/A" %></td>
              </tr>
              <% if @user.Role == "Tenant" %>
                <tr>
                  <th>Landlord Name</th>
                  <td><%= @mediation.landlord.FName %> <%= @mediation.landlord.LName %></td>
                </tr>
                <tr>
                  <th>Landlord Email</th>
                  <td><%= @mediation.landlord.Email %></td>
                </tr>
                <% if (mediator = @mediation&.mediator) %>
                  <tr>
                    <th>Mediator Name</th>
                    <td><%= [mediator.FName, mediator.LName].compact.join(" ").squeeze(" ").strip.presence || mediator.Email %></td>
                  </tr>
                  <tr>
                    <th>Mediator Email</th>
                    <td><%= mediator.Email %></td>
                  </tr>
                <% end %>
              <% elsif @user.Role == "Landlord" %>
                <tr>
                  <th>Tenant Name</th>
                  <td><%= @mediation.tenant.FName %> <%= @mediation.tenant.LName %></td>
                </tr>
                <tr>
                  <th>Tenant Email</th>
                  <td><%= @mediation.tenant.Email %></td>
                </tr>
                <% if (mediator = @mediation&.mediator) %>
                  <tr>
                    <th>Mediator Name</th>
                    <td><%= [mediator.FName, mediator.LName].compact.join(" ").squeeze(" ").strip.presence || mediator.Email %></td>
                  </tr>
                  <tr>
                    <th>Mediator Email</th>
                    <td><%= mediator.Email %></td>
                  </tr>
                <% end %>
              <% end %>
            </table>
          </div>
        </div>
      </div>
    </div>
    <% mediator_screening_needed = @mediation&.MediatorRequested && @mediation&.MediatorAssigned &&
      ((@user.Role == "Tenant" && @mediation.TenantScreeningID.nil?) ||
      (@user.Role == "Landlord" && @mediation.LandlordScreeningID.nil?)) %>

    <%
      mediator_chat_ready = @mediation&.MediatorRequested && @mediation&.MediatorAssigned &&
        (
          (tenant_screening&.flagged != true) && (landlord_screening&.flagged != true)
        )
    %>

    <% if mediator_chat_ready %>
      <!-- Mediator Chatbox -->
      <div class="message-page-container chat-layout">
        <section class="chat-panel-wrapper">
          <%= render partial: "mediator_chatbox", locals: {
            recipient: @mediator,
            messages: @messages,
            message_string: @message_string,
            current_user: @user,
            participants: @conversation_participants
          } %>
        </section>
          <div class="chat-actions-column">
          <%= render 'actions' %>
          </div>
      </div>
    <% elsif (tenant_screening&.flagged == true || landlord_screening&.flagged == true) %>
      <p class="alert alert-warning">One of the party's screening questions has been flagged and is under review by an administrator. Please wait before continuing mediation.</p>
    <% elsif mediator_screening_needed %>
      
        <%= render 'actions' %>
      
    <% else %>
      <!-- Normal Chatbox and Actions Side-by-side Layout -->
      <div class="message-page-container chat-layout">
        <section class="chat-panel-wrapper">
          <%= render 'negotiation_chatbox', participants: @conversation_participants, current_user: @user %>
        </section>
          <div class="chat-actions-column">
          <%= render 'actions' %>
          </div>
      </div>
    <% end %>
  <% else %>
    <%= render "good_faith_prompt", mediation: @mediation, user: @user %>
  <% end %>
</div>

<!-- Pass mediator status clearly to JavaScript -->
<script>
  window.mediatorAssigned = <%= @mediation&.MediatorRequested && @mediation&.MediatorAssigned ? 'true' : 'false' %>;
</script>
