<section class="chat-panel" aria-label="Conversation thread">
  <div class="message-list-container" data-message-scroll>
    <div class="message-list"
         id="messages"
         data-conversation-id="<%= @message_string.ConversationID %>"
         data-current-user-id="<%= current_user.UserID %>"
         data-current-user-role="<%= current_user.Role %>">

      <% if @messages.any? %>
        <% @messages.each do |message| %>
          <% sender = participants[message.SenderID] %>
          <% attachments = message.file_attachments.includes(:file_draft) %>
          <%= render partial: "messages/message", locals: {
                message: message,
                current_user: current_user,
                sender: sender,
                participants: participants,
                attachments: attachments
              } %>
        <% end %>
      <% else %>
        <p class="no-messages">No messages in this conversation yet.</p>
      <% end %>
    </div>
  </div>

  <div id="new_message_form" class="message-composer">
    <%= form_with url: messages_path, method: :post, data: { turbo: "false" } do |f| %>
      <%= f.hidden_field :ConversationID, value: @message_string.ConversationID, id: "conversation_id" %>

      <div class="composer-input-row">
        <button type="button" class="composer-attach-btn" data-attachment-toggle aria-label="Attach a document">
          <i class="fa-solid fa-paperclip" aria-hidden="true"></i>
          <span class="composer-attach-label">Docs</span>
        </button>

        <div class="composer-field">
          <%= f.text_area :Contents,
            placeholder: "Type your message...",
            id: "message_contents",
            class: "message-textarea",
            rows: 3 %>
        </div>

        <%= f.submit "Send", class: "send-msg-btn" %>
      </div>

      <div class="composer-attachments" data-attachment-menu hidden>
        <div class="file-dropdown-wrapper">
          <%= f.label :file_id, "Attach an existing file", class: "file-label" %>
          <div class="custom-select-wrapper">
            <% available_files = FileDraft.where(CreatorID: current_user.UserID) %>
            <% available_files = available_files.where(UserDeletedAt: nil) if FileDraft.column_names.include?("UserDeletedAt") %>

            <%= f.collection_select :file_id,
                                    available_files,
                                    :FileID,
                                    ->(fd) { "#{fd.FileName}#{fd.FileTypes.present? ? " (#{fd.FileTypes.upcase})" : ""}" },
                                    { prompt: "Choose a file" },
                                    { class: "form-control", required: false } %>
            <i class="arrow down"></i>
          </div>
        </div>
        <div class="composer-attachment-links">
          <%= link_to new_document_path, class: "attachment-link" do %>
            <i class="fa-solid fa-upload" aria-hidden="true"></i>
            Upload a new document
          <% end %>
          <%= link_to generate_file_path, class: "attachment-link" do %>
            <i class="fa-solid fa-file-circle-plus" aria-hidden="true"></i>
            Generate a document
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</section>

<div class="document-preview-overlay" data-document-preview hidden>
  <div class="document-preview-dialog" role="dialog" aria-modal="true" aria-labelledby="document-preview-title">
    <header class="document-preview-header">
      <div class="document-preview-title">
        <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
        <h3 id="document-preview-title" data-document-preview-name>Document preview</h3>
      </div>
      <button type="button" class="document-preview-close" data-document-preview-close aria-label="Close document preview">
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>
    </header>
    <div class="document-preview-body">
      <iframe data-document-preview-frame title="Document preview" frameborder="0"></iframe>
    </div>
  </div>
</div>
