<% broadcast_enabled = local_assigns.fetch(:broadcast_enabled, false) %>
<% message_placeholder = local_assigns[:placeholder_text].presence || "Type your message..." %>
<% composer_enabled = local_assigns.fetch(:composer_enabled, true) %>
<% composer_disabled_reason = local_assigns[:composer_disabled_reason] %>

<section class="chat-panel" aria-label="Conversation thread">
  <div class="message-list-container" data-message-scroll>
    <div class="message-list"
         id="messages"
         data-conversation-id="<%= @message_string.ConversationID %>"
         data-current-user-id="<%= current_user.UserID %>"
         data-current-user-role="<%= current_user.Role %>"
         data-broadcast-enabled="<%= broadcast_enabled %>">

      <% if @messages.any? %>
        <% @messages.each do |message| %>
          <% sender = participants[message.SenderID] %>
          <% attachments = if message.association(:file_attachments).loaded?
                             message.file_attachments
                           else
                             message.file_attachments.includes(:file_draft)
                           end %>
          <%= render partial: "messages/message", locals: {
                message: message,
                current_user: current_user,
                sender: sender,
                participants: participants,
                attachments: attachments
              } %>
        <% end %>
      <% else %>
        <p class="no-messages">No messages in this conversation yet.</p>
      <% end %>
    </div>
  </div>

  <div id="new_message_form" class="message-composer" data-composer-enabled="<%= composer_enabled %>">
    <% if composer_enabled %>
      <%= form_with url: messages_path, method: :post, data: { turbo: "false" } do |f| %>
        <%= f.hidden_field :ConversationID, value: @message_string.ConversationID, id: "conversation_id" %>

        <div class="composer-input-row">
          <button type="button" class="composer-attach-btn" data-attachment-toggle aria-label="Attach a document">
            <i class="fa-solid fa-paperclip" aria-hidden="true"></i>
            <span class="composer-attach-label">Docs</span>
          </button>

          <div class="composer-field">
            <%= f.text_area :Contents,
              placeholder: message_placeholder,
              id: "message_contents",
              class: "message-textarea",
              rows: 3 %>
          </div>

          <%= f.submit "Send", class: "send-msg-btn" %>
        </div>

        <div class="composer-attachments" data-attachment-menu hidden>
          <div class="file-dropdown-wrapper">
            <%= f.label :file_id, "Attach an existing file", class: "file-label" %>
            <div class="custom-select-wrapper">
              <%= f.collection_select :file_id,
                    FileDraft.where(CreatorID: current_user.UserID),
                    :FileID,
                    :FileName,
                    { prompt: "Choose a file" },
                    { class: "form-control", required: false } %>
              <i class="arrow down"></i>
            </div>
          </div>
          <div class="composer-attachment-links">
            <%= link_to new_document_path, class: "attachment-link" do %>
              <i class="fa-solid fa-upload" aria-hidden="true"></i>
              Upload a new document
            <% end %>
            <%= link_to generate_file_path, class: "attachment-link" do %>
              <i class="fa-solid fa-file-circle-plus" aria-hidden="true"></i>
              Generate a document
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="composer-disabled">
        <p class="composer-disabled__message"><%= composer_disabled_reason.presence || "Messaging is temporarily unavailable for this conversation." %></p>
      </div>
    <% end %>
  </div>
</section>

<div class="document-preview-overlay" data-document-preview hidden>
  <div class="document-preview-dialog" role="dialog" aria-modal="true" aria-labelledby="document-preview-title">
    <header class="document-preview-header">
      <div class="document-preview-title">
        <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
        <h3 id="document-preview-title" data-document-preview-name>Document preview</h3>
      </div>
      <button type="button" class="document-preview-close" data-document-preview-close aria-label="Close document preview">
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>
    </header>
    <div class="document-preview-body">
      <iframe data-document-preview-frame title="Document preview" frameborder="0"></iframe>
    </div>
  </div>
</div>
