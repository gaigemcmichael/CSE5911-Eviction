<% mediation_requested = @mediation&.MediatorRequested.present? %>
<% mediation_assigned = @mediation&.MediatorRequested && @mediation&.MediatorAssigned %>
<% can_request_mediator = @mediation && !mediation_requested && !mediation_assigned %>

<div class="conversation-actions" data-chat-actions>
  <% show_status_card = @mediation.present? && (mediation_assigned || mediation_requested) %>

  <% if show_status_card %>
    <div id="mediation-status-container">
      <% if mediation_assigned %>
        <% mediator = @mediation&.mediator %>
        <% mediator_name = mediator ? [mediator.FName, mediator.LName].compact.join(" ").squeeze(" ").strip : "A mediator" %>
        <div class="conversation-banner conversation-banner--success">
          <i class="fa-solid fa-handshake" aria-hidden="true"></i>
          <span>Mediator <strong><%= mediator_name %></strong> has been assigned to this case.</span>
        </div>
      <% elsif mediation_requested %>
        <div class="conversation-card">
          <div class="conversation-status conversation-status--info">
            <i class="fa-solid fa-clock" aria-hidden="true"></i>
            Mediator requested. We'll notify you when someone is assigned.
          </div>
        </div>
      <% end %>
    </div>
  <% elsif @mediation.blank? %>
    <div class="conversation-card conversation-card--warning">
      <div class="conversation-status conversation-status--warning">
        We couldn't load mediation details. Please refresh.
      </div>
    </div>
  <% end %>

  <div class="conversation-actions__button-stack">
    <% if can_request_mediator %>
      <button type="button"
              class="conversation-cta conversation-cta--primary"
              data-mediator-modal-open>
        <span class="conversation-cta__icon"><i class="fa-solid fa-handshake"></i></span>
        <span class="conversation-cta__label">Request a mediator</span>
      </button>
    <% else %>
      <button type="button"
              class="conversation-cta conversation-cta--primary is-disabled"
              disabled>
        <span class="conversation-cta__icon"><i class="fa-solid fa-handshake-angle"></i></span>
        <span class="conversation-cta__label"><%= mediation_assigned ? "Mediator assigned" : "Mediator requested" %></span>
      </button>
    <% end %>

    <button type="button"
            class="conversation-cta conversation-cta--danger"
            data-end-modal-open>
      <span class="conversation-cta__icon"><i class="fa-solid fa-circle-xmark"></i></span>
      <span class="conversation-cta__label">End <%= mediation_assigned ? 'Mediation' : 'Negotiation' %></span>
    </button>
  </div>

  <% if @mediation.present? %>
    <div class="conversation-modal" data-mediator-modal hidden role="dialog" aria-modal="true" aria-labelledby="mediator-modal-title">
      <div class="conversation-modal__content">
        <div class="conversation-modal__header">
          <h3 id="mediator-modal-title">Request a mediator?</h3>
          <button type="button" class="conversation-modal__close" data-mediator-modal-close aria-label="Close mediator request confirmation">
            <i class="fa-solid fa-xmark" aria-hidden="true"></i>
          </button>
        </div>
        <p class="conversation-modal__body">
          A mediator can guide the conversation and help both parties reach an agreement. Do you want to submit this request now?
        </p>
        <div class="conversation-modal__actions">
          <%= button_to "Confirm request",
              request_mediator_message_path(@mediation.id),
              method: :patch,
              class: "conversation-action conversation-action--primary" %>
          <button type="button" class="conversation-action conversation-action--ghost" data-mediator-modal-close>Cancel</button>
        </div>
      </div>
    </div>

    <div class="conversation-modal" data-end-modal hidden role="dialog" aria-modal="true" aria-labelledby="end-modal-title">
      <div class="conversation-modal__content">
        <div class="conversation-modal__header">
          <h3 id="end-modal-title">End <%= mediation_assigned ? 'Mediation' : 'Negotiation' %>?</h3>
          <button type="button" class="conversation-modal__close" data-end-modal-close aria-label="Close end confirmation">
            <i class="fa-solid fa-xmark" aria-hidden="true"></i>
          </button>
        </div>
        <p class="conversation-modal__body">
          This will permanently close the <%= mediation_assigned ? 'mediation' : 'negotiation' %>. You'll be prompted to share feedback about the other party's good faith efforts.
        </p>
        <div class="conversation-modal__actions">
          <%= button_to "Confirm end",
              end_mediation_path(@mediation.ConversationID),
              method: :patch,
              data: { turbo: false },
              class: "conversation-action conversation-action--danger" %>
          <button type="button" class="conversation-action conversation-action--ghost" data-end-modal-close>Cancel</button>
        </div>
      </div>
    </div>
  <% end %>

  <% if @user&.Role != "Mediator" %>
    <div class="conversation-modal chat-disclaimer-modal" data-disclaimer-modal data-user-role="<%= @user.Role %>" hidden role="dialog" aria-modal="true" aria-labelledby="disclaimer-modal-title">
      <div class="conversation-modal__content">
        <div class="conversation-modal__header">
          <h3 id="disclaimer-modal-title">Chat Terms</h3>
          <button type="button" class="conversation-modal__close" data-disclaimer-modal-close aria-label="Close disclaimer">
            <i class="fa-solid fa-xmark" aria-hidden="true"></i>
          </button>
        </div>
        <div class="conversation-modal__body">
          <p>
            Messages shared in this chat box are used for mediation and negotiation purposes only.
          </p>
          <p>
            The mediator may review these messages to <strong>help guide the conversation</strong>, but they <strong>do not represent either party</strong> and cannot give legal advice.
          </p>
          <p>
            By continuing to use this chat, you agree to these terms.
          </p>
        </div>
        <div class="conversation-modal__actions">
          <button type="button" class="conversation-action conversation-action--primary" data-disclaimer-modal-close>I Understand</button>
        </div>
      </div>
    </div>
  <% end %>
</div>