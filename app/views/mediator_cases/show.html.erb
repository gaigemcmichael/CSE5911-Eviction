<%= stylesheet_link_tag "admin_mediations", "data-turbo-track": "reload" %>

<div class="admin-mediation-details-container">
  <% tenant_screening = ScreeningQuestion.find_by(ScreeningID: @mediation.TenantScreeningID) %>
  <% landlord_screening = ScreeningQuestion.find_by(ScreeningID: @mediation.LandlordScreeningID) %>
  <% flagged = tenant_screening&.flagged || landlord_screening&.flagged %>

  <!-- Header -->
  <div class="page-header">
    <%= link_to third_party_mediations_path, class: "back-link" do %>
      <i class="fa-solid fa-arrow-left"></i> Back to My Cases
    <% end %>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h1>Mediation Case Details</h1>
      <% if @mediation.deleted_at.nil? && !flagged %>
        <%= link_to message_path(@mediation.ConversationID), class: "btn btn-primary" do %>
          <i class="fa-solid fa-comments"></i> Open Chat
        <% end %>
      <% end %>
    </div>
  </div>

  <% if @mediation.deleted_at.nil? %>
    <% if !flagged %>
      <div class="details-grid">
        <!-- Left Column: Landlord & Actions -->
        <div class="details-column left-column">
          <!-- Landlord Card -->
          <div class="info-card">
            <div class="card-header">
              <h2><i class="fa-solid fa-house-user"></i> Landlord</h2>
            </div>
            <div class="card-body">
              <div class="info-row">
                <span class="label">Name</span>
                <span class="value"><%= @mediation.landlord.FName %> <%= @mediation.landlord.LName %></span>
              </div>
              <div class="info-row">
                <span class="label">Email</span>
                <span class="value"><%= @mediation.landlord.Email %></span>
              </div>
              <div class="info-row">
                <span class="label">Phone</span>
                <span class="value"><%= @mediation.landlord.PhoneNumber.presence || "N/A" %></span>
              </div>
              <% if @mediation.landlord.CompanyName.present? %>
                <div class="info-row">
                  <span class="label">Company</span>
                  <span class="value"><%= @mediation.landlord.CompanyName %></span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Actions Card -->
          <div class="info-card">
            <div class="card-header">
              <h2><i class="fa-solid fa-gavel"></i> Actions</h2>
            </div>
            <div class="card-body">
              <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                End the mediation if an agreement has been reached or if mediation is no longer viable.
              </p>
              <%= button_to end_mediation_path(@mediation.ConversationID),
                  method: :patch,
                  data: { turbo: false },
                  onclick: "return confirm('Are you sure you want to end this mediation? This action cannot be undone.');",
                  class: "btn btn-outline-danger",
                  style: "width: 100%; justify-content: center;" do %>
                <i class="fa-solid fa-ban"></i> Terminate Mediation
              <% end %>
            </div>
          </div>
        </div>

        <!-- Right Column: Tenant Info & Intake -->
        <div class="details-column right-column">
          <div class="info-card">
            <div class="card-header">
              <h2><i class="fa-solid fa-user"></i> Tenant</h2>
            </div>
            <div class="card-body">
              <!-- Contact Info -->
              <div class="info-row">
                <span class="label">Name</span>
                <span class="value"><%= @mediation.tenant.FName %> <%= @mediation.tenant.LName %></span>
              </div>
              <div class="info-row">
                <span class="label">Email</span>
                <span class="value"><%= @mediation.tenant.Email %></span>
              </div>
              <div class="info-row">
                <span class="label">Phone</span>
                <span class="value"><%= @mediation.tenant.PhoneNumber.presence || "N/A" %></span>
              </div>
              <div class="info-row">
                <span class="label">Address</span>
                <span class="value"><%= @mediation.tenant.TenantAddress.presence || "N/A" %></span>
              </div>

              <!-- Intake Responses -->
              <% if @mediation.intake_question %>
                <div class="screening-section">
                  <h3>Intake Responses</h3>
                  <div class="screening-grid">
                    <div class="screening-item">
                      <span class="q-label">Reason for Mediation</span>
                      <span class="q-value"><%= @mediation.intake_question.Reason %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Describe the Cause</span>
                      <span class="q-value"><%= @mediation.intake_question.DescribeCause.presence || "N/A" %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Best Option</span>
                      <span class="q-value"><%= @mediation.intake_question.BestOption %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Uses Section 8?</span>
                      <span class="q-value"><%= @mediation.intake_question.Section8 ? "Yes" : "No" %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Money Owed</span>
                      <span class="q-value">$<%= @mediation.intake_question.MoneyOwed %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Total or Monthly?</span>
                      <span class="q-value"><%= @mediation.intake_question.TotalCostOrMonthly ? "Monthly" : "Total" %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Monthly Rent</span>
                      <span class="q-value">$<%= @mediation.intake_question.MonthlyRent || "N/A" %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Date Due</span>
                      <span class="q-value"><%= @mediation.intake_question.DateDue&.strftime("%B %d, %Y") || "N/A" %></span>
                    </div>
                    <div class="screening-item">
                      <span class="q-label">Payable Today</span>
                      <span class="q-value"><%= @mediation.intake_question.PayableToday %></span>
                    </div>
                  </div>
                </div>
              <% end %>

              <!-- Screening Questionnaire (Only if exists) -->
              <% if tenant_screening %>
                <div class="screening-section">
                  <h3>Screening Questionnaire</h3>
                  <div class="screening-grid">
                    <div class="screening-item">
                      <span class="q-label">Interpreter Needed?</span>
                      <span class="q-value <%= tenant_screening.InterpreterNeeded ? 'text-warning' : '' %>">
                        <%= tenant_screening.InterpreterNeeded ? "Yes" : "No" %>
                      </span>
                      <% if tenant_screening.InterpreterNeeded %>
                        <div class="q-detail">Language: <%= tenant_screening.InterpreterLanguage %></div>
                      <% end %>
                    </div>

                    <div class="screening-item">
                      <span class="q-label">Disability Accommodation?</span>
                      <span class="q-value <%= tenant_screening.DisabilityAccommodation ? 'text-warning' : '' %>">
                        <%= tenant_screening.DisabilityAccommodation ? "Yes" : "No" %>
                      </span>
                      <% if tenant_screening.DisabilityAccommodation %>
                        <div class="q-detail"><%= tenant_screening.DisabilityExplanation %></div>
                      <% end %>
                    </div>

                    <div class="screening-item">
                      <span class="q-label">Conflict of Interest?</span>
                      <span class="q-value <%= tenant_screening.ConflictOfInterest ? 'text-danger' : '' %>">
                        <%= tenant_screening.ConflictOfInterest ? "Yes" : "No" %>
                      </span>
                    </div>

                    <div class="screening-item">
                      <span class="q-label">Can Speak on Own Behalf?</span>
                      <span class="q-value <%= !tenant_screening.SpeakOnOwnBehalf ? 'text-warning' : '' %>">
                        <%= tenant_screening.SpeakOnOwnBehalf ? "Yes" : "No" %>
                      </span>
                    </div>

                    <div class="screening-item">
                      <span class="q-label">Need to Consult?</span>
                      <span class="q-value <%= tenant_screening.NeedToConsult ? 'text-info' : '' %>">
                        <%= tenant_screening.NeedToConsult ? "Yes" : "No" %>
                      </span>
                      <% if tenant_screening.NeedToConsult %>
                        <div class="q-detail"><%= tenant_screening.ConsultExplanation %></div>
                      <% end %>
                    </div>

                    <% if tenant_screening.RelationshipToOtherParty.present? %>
                      <div class="screening-item full-width">
                        <span class="q-label">Relationship to Landlord</span>
                        <div class="q-detail"><%= tenant_screening.RelationshipToOtherParty %></div>
                      </div>
                    <% end %>

                    <div class="screening-item full-width">
                      <span class="q-label">Feel Unsafe?</span>
                      <span class="q-value <%= tenant_screening.Unsafe ? 'text-danger' : '' %>">
                        <%= tenant_screening.Unsafe ? "Yes" : "No" %>
                      </span>
                      <% if tenant_screening.Unsafe %>
                        <div class="q-detail warning-box">
                          <i class="fa-solid fa-triangle-exclamation"></i>
                          <%= tenant_screening.UnsafeExplanation %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <!-- Flagged State -->
      <div class="info-card" style="max-width: 600px; margin: 4rem auto;">
        <div class="card-body text-center" style="padding: 3rem;">
          <div class="status-icon text-warning mb-3" style="font-size: 3rem; margin-bottom: 1.5rem;">
            <i class="fa-solid fa-flag"></i>
          </div>
          <h2 style="margin-bottom: 1rem;">Mediation Flagged</h2>
          <p style="color: #64748b;">One of the screenings has been flagged for review by an admin. You cannot proceed until it is resolved.</p>
        </div>
      </div>
    <% end %>
  <% else %>
    <!-- Ended State -->
    <div class="info-card" style="max-width: 600px; margin: 4rem auto;">
      <div class="card-body text-center" style="padding: 3rem;">
        <div class="status-icon text-secondary mb-3" style="font-size: 3rem; margin-bottom: 1.5rem; color: #94a3b8;">
          <i class="fa-solid fa-ban"></i>
        </div>
        <h2 style="margin-bottom: 1rem;">Mediation Ended</h2>
        <p style="color: #64748b;">This mediation case has been closed.</p>
      </div>
    </div>
  <% end %>
</div>

