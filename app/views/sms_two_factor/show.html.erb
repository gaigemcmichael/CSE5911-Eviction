<div class="sms-2fa-page">
  <div class="sms-2fa-container">
    <!-- Header Section -->
    <div class="sms-2fa-header">
      <div class="sms-icon">
        <i class="fa-solid fa-mobile-screen"></i>
      </div>
      <h1 class="sms-2fa-title">SMS Verification</h1>
      <p class="sms-2fa-subtitle">We've sent a verification code to your phone</p>
    </div>

    <!-- Alert Messages -->
    <% if flash[:error] %>
      <div class="alert alert-error">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <%= flash[:error] %>
      </div>
    <% end %>

    <% if flash[:notice] %>
      <div class="alert alert-success">
        <i class="fa-solid fa-check-circle"></i>
        <%= flash[:notice] %>
      </div>
    <% end %>

    <!-- Verification Form -->
    <div class="sms-2fa-form-container">
      <%= form_with url: sms_two_factor_verify_path, method: :post, class: "sms-2fa-form" do %>
        <div class="form-group">
          <%= label_tag :otp_code, "Enter 6-digit code", class: "form-label" %>
          <%= text_field_tag :otp_code, nil, 
                autofocus: true, 
                autocomplete: "one-time-code",
                placeholder: "000000",
                maxlength: 6,
                pattern: "[0-9]{6}",
                class: "otp-input",
                id: "otp-code-input" %>
        </div>
        
        <div class="form-actions">
          <%= submit_tag "Verify Code", class: "btn btn-verify" %>
        </div>
      <% end %>

      <!-- Resend Section -->
      <div class="resend-section">
        <p class="resend-text">Didn't receive the code?</p>
        <%= button_to 'Resend Code', sms_two_factor_resend_path, 
              method: :post, 
              class: 'btn btn-resend',
              id: 'resend-btn' %>
      </div>
    </div>

    <!-- Help Text -->
    <div class="help-section">
      <p class="help-text">
        <i class="fa-solid fa-info-circle"></i>
        The code may take up to 30 seconds to arrive. Check your text messages.
      </p>
    </div>

    <!-- Back to Login -->
    <div class="sms-back-link">
      <%= link_to new_session_path, class: "sms-link" do %>
        <i class="fas fa-arrow-left"></i>Back to Login
      <% end %>
    </div>
  </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const otpInput = document.getElementById('otp-code-input');
  const resendBtn = document.getElementById('resend-btn');
  const verifyBtn = document.querySelector('.btn-verify');
  const form = document.querySelector('.sms-2fa-form');
  
  // Auto-format OTP input
  otpInput.addEventListener('input', function(e) {
    // Remove non-numeric characters
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
    
    // Auto-submit when 6 digits are entered
    if (e.target.value.length === 6) {
      verifyBtn.classList.add('loading');
      setTimeout(() => {
        form.submit();
      }, 800); // Slight delay for better UX
    }
  });
  
  // Prevent form submission with incomplete code
  form.addEventListener('submit', function(e) {
    if (otpInput.value.length !== 6) {
      e.preventDefault();
      otpInput.focus();
      // Add shake animation for invalid input
      otpInput.style.animation = 'shake 0.5s';
      setTimeout(() => {
        otpInput.style.animation = '';
      }, 500);
      return false;
    }
    verifyBtn.classList.add('loading');
  });
  
  // Resend cooldown
  let cooldownTime = 30;
  function startCooldown() {
    resendBtn.disabled = true;
    resendBtn.innerHTML = `<i class="fa-solid fa-clock"></i> Resend in ${cooldownTime}s`;
    
    const countdown = setInterval(() => {
      cooldownTime--;
      resendBtn.innerHTML = `<i class="fa-solid fa-clock"></i> Resend in ${cooldownTime}s`;
      
      if (cooldownTime <= 0) {
        clearInterval(countdown);
        resendBtn.disabled = false;
        resendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Resend Code';
        cooldownTime = 30;
      }
    }, 1000);
  }
  
  // Start cooldown on page load (assume code was just sent)
  startCooldown();
  
  // Restart cooldown when resend is clicked
  resendBtn.addEventListener('click', function() {
    startCooldown();
  });
  
  // Focus input on load
  otpInput.focus();
});
</script>

<style>
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}
</style>
