<% content_for :title, "SMS Verification" %>
<%= stylesheet_link_tag 'sms_two_factor' %>

<div class="sms-verification-container">
  <div class="sms-verification-card">
    <div class="sms-card-content">
      <!-- Header Section -->
      <div class="sms-header">
        <div class="sms-icon-container">
          <i class="fas fa-mobile-alt sms-icon"></i>
        </div>
        <h2 class="sms-title">SMS Verification</h2>
        <p class="sms-subtitle">
          We've sent a verification code to
        </p>
        <p class="sms-phone-number">
          <%= @user&.phone_number || "your phone" %>
        </p>
      </div>

      <!-- Flash Messages -->
      <% if flash[:error] %>
        <div class="sms-alert sms-alert-error" role="alert">
          <i class="fas fa-exclamation-circle"></i>
          <%= flash[:error] %>
        </div>
      <% end %>

      <% if flash[:notice] %>
        <div class="sms-alert sms-alert-success" role="alert">
          <i class="fas fa-check-circle"></i>
          <%= flash[:notice] %>
        </div>
      <% end %>

      <!-- Verification Form -->
      <div class="sms-form">
        <%= form_with url: verify_sms_two_factor_path, method: :post, local: true, class: "sms-verification-form" do |f| %>
          <div class="sms-input-group">
            <%= label_tag :otp_code, "Enter Verification Code", class: "sms-label" %>
            <%= text_field_tag :otp_code, nil, 
                class: "sms-code-input", 
                placeholder: "000000",
                maxlength: 6,
                pattern: "\\d{6}",
                required: true,
                autocomplete: "off",
                id: "otp-code-input" %>
            <div class="sms-input-error">
              <i class="fas fa-exclamation-triangle"></i>
              Please enter a valid 6-digit verification code.
            </div>
            <div class="sms-input-info">
              <i class="fas fa-info-circle"></i>
              Code expires in 10 minutes
            </div>
          </div>
          
          <div class="sms-button-group">
            <%= f.submit "Verify Code", 
                class: "sms-btn-primary",
                data: { "disable-with": '<i class="sms-spinner"></i>Verifying...' } %>
          </div>
        <% end %>
      </div>

      <!-- Resend Section -->
      <div class="sms-resend-section">
        <p class="sms-resend-text">Didn't receive the code?</p>
        
        <%= form_with url: resend_sms_two_factor_path, method: :post, local: true, class: "sms-resend-form", id: "resend-form" do |f| %>
          <%= f.submit "Resend Code", 
              class: "sms-btn-secondary",
              id: "resend-btn",
              data: { "disable-with": '<i class="sms-spinner"></i>Sending...' } %>
        <% end %>
        
        <div id="resend-timer" class="sms-resend-timer" style="display: none;">
          <i class="fas fa-clock"></i>
          You can resend in <span id="countdown">30</span> seconds
        </div>
      </div>

      <!-- Help Text -->
      <div class="help-section">
        <p class="help-text">
          <i class="fa-solid fa-info-circle"></i>
          The code may take up to 30 seconds to arrive. Check your text messages.
        </p>
      </div>

      <!-- Back to Login -->
      <div class="sms-back-link">
        <%= link_to new_session_path, class: "sms-link" do %>
          <i class="fas fa-arrow-left"></i>Back to Login
        <% end %>
      </div>

      <!-- Security Notice -->
      <div class="sms-security-notice">
        <i class="fas fa-shield-alt"></i>
        This is a security measure to protect your account
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const otpInput = document.getElementById('otp-code-input');
  const resendBtn = document.getElementById('resend-btn');
  const verifyBtn = document.querySelector('.sms-btn-primary');
  const form = document.querySelector('.sms-verification-form');
  
  // Auto-format OTP input
  otpInput.addEventListener('input', function(e) {
    // Remove non-numeric characters
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
    
    // Auto-submit when 6 digits are entered
    if (e.target.value.length === 6) {
      verifyBtn.classList.add('loading');
      setTimeout(() => {
        form.submit();
      }, 800); // Slight delay for better UX
    }
  });
  
  // Prevent form submission with incomplete code
  form.addEventListener('submit', function(e) {
    if (otpInput.value.length !== 6) {
      e.preventDefault();
      otpInput.focus();
      // Add shake animation for invalid input
      otpInput.style.animation = 'shake 0.5s';
      setTimeout(() => {
        otpInput.style.animation = '';
      }, 500);
      return false;
    }
    verifyBtn.classList.add('loading');
  });
  
  // Resend cooldown
  let cooldownTime = 30;
  function startCooldown() {
    resendBtn.disabled = true;
    resendBtn.innerHTML = `<i class="fa-solid fa-clock"></i> Resend in ${cooldownTime}s`;
    
    const countdown = setInterval(() => {
      cooldownTime--;
      resendBtn.innerHTML = `<i class="fa-solid fa-clock"></i> Resend in ${cooldownTime}s`;
      
      if (cooldownTime <= 0) {
        clearInterval(countdown);
        resendBtn.disabled = false;
        resendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Resend Code';
        cooldownTime = 30;
      }
    }, 1000);
  }
  
  // Start cooldown on page load (assume code was just sent)
  startCooldown();
  
  // Restart cooldown when resend is clicked
  resendBtn.addEventListener('click', function() {
    startCooldown();
  });
  
  // Focus input on load
  otpInput.focus();
});
</script>

<style>
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}
</style>

<%= javascript_include_tag 'sms_two_factor' %>
