<%# Use a softer intake-specific background so the navbar remains visually distinct %>
<% content_for :body_class, 'intake-page' %>

<div class="signup-container">
  <div class="signup-card intake-card" style="max-width: 820px;">
    <h1>Start Your Intake Questions</h1>
      <h2>Please complete the following intake questions before proceeding with negotiation.</h2>

    <%= form_with(model: @intake_question, url: intake_questions_path(conversation_id: @conversation_id), local: true) do |f| %>

      <div class="form-section">
        <%= f.label :Reason, "What is the reason for the dispute?", class: "required-label" %>

        <div class="custom-select-wrapper">
          <%= f.select :Reason, [
            "Failure to Pay Rent",
            "Violation of Lease Terms",
            "Damage to Property",
            "Illegal Activity",
            "Nuisance or Disturbance",
            "Expiration of Lease",
            "Unknown"
          ], { prompt: "Select a reason" }, { class: "form-control", required: true } %>

          <i class="arrow down"></i>
        </div>
      </div>

      <div class="form-section">
        <%= f.label :DescribeCause, "Please describe what caused this dispute. In other words, what happened?", class: "required-label" %>
        <p>This information will not be shared with the Landlord. It is an opportunity for you to share your side of the story.</p>
        <%= f.text_area :DescribeCause, rows: 5, class: "form-control", required: true %>
      </div>

      <div class="form-section">
        <p>Many eviction disputes end with an agreement where the tenant agrees to do one of the following:</p>
        <ul>
          <li>Pay the rent that was due</li>
          <li>Move out</li>
        </ul>
        <p>While there may be other options through conversation or mediation, these are the most common.</p>

        <%= f.label :BestOption, "Which of the following is the best option for you?", class: "required-label" %>

        <div class="custom-select-wrapper">
          <%= f.select :BestOption, [
            "Pay Missed Rent", 
            "Move Out"
          ], { prompt: "Select an option" }, { class: "form-control", required: true } %>
          <i class="arrow down"></i>
        </div>
      </div>

      <div class="form-section">
        <%= f.label :Section8, "Are you in Section 8 Housing?", class: "required-label" %>
        
        <p>If you are in Section 8 Housing, you may qualify for Legal Aid Resources. You are encouraged to 
          <strong><a href="https://oslsaoi.legalserver.org/modules/matter/extern_intake.php?pid=129&h=daa817&" target="_blank">contact Legal Aid</a></strong>.
        </p>
        <label style="cursor: pointer; font-weight: normal;">
          <%= f.radio_button :Section8, true, required: true %> Yes
        </label>
        <label style="cursor: pointer; font-weight: normal;">
          <%= f.radio_button :Section8, false %> No
        </label>
        
      </div>

      <div class="form-section">
        <%= f.label :MoneyOwed, "How much money do you currently owe in rent?", class: "required-label" %>
        <p>Please check your online rental portal or any place where your rent balance is shown.</p>
        <%= f.number_field :MoneyOwed, step: 0.01, class: "form-control", required: true, placeholder: "e.g. 1200.00" %>
      </div>

      <div class="form-section">
        <%= f.label :TotalCostOrMonthly, "Is the amount you typed above the total cost of your monthly rent?", class: "required-label" %><br>
        <label style="cursor: pointer; font-weight: normal;">
          <%= f.radio_button :TotalCostOrMonthly, true, required: true, id: "total_cost_yes" %> Yes
        </label>
        <label style="cursor: pointer; font-weight: normal;">
          <%= f.radio_button :TotalCostOrMonthly, false, id: "total_cost_no" %> No
        </label>
        
        <div id="monthly-rent-section" style="display: none; margin-top: 12px;">
          <%= f.label :MonthlyRent, "What is the total rent you pay each month?" %>
          <%= f.number_field :MonthlyRent, step: 0.01, class: "form-control", placeholder: "e.g. 800.00", id: "monthly_rent_field" %>
        </div>
      </div>

      <div class="form-section">
        <%= f.label :DateDue, "When was your rent due?", class: "required-label" %>
        <%= f.date_field :DateDue, class: "form-control", required: true %>
      </div>

      <div class="form-section">
        <%= f.label :PayableToday, "How much money could you pay today?", class: "required-label" %>
        <p>It's okay to type “0” if you cannot pay any of the rent due today.</p>
        <%= f.number_field :PayableToday, step: 0.01, class: "form-control", required: true, placeholder: "e.g. 0.00" %>
      </div>

      <div class="form-footer">
        <%= f.submit "Submit", class: 'signup-btn' %>
      </div>

    <% end %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const monthlyRentSection = document.getElementById('monthly-rent-section');
    const monthlyRentField = document.getElementById('monthly_rent_field');
    const totalCostYes = document.getElementById('total_cost_yes');
    const totalCostNo = document.getElementById('total_cost_no');

    // Toggle monthly rent field visibility
    function toggleMonthlyRent() {
      if (totalCostNo && totalCostNo.checked) {
        monthlyRentSection.style.display = 'block';
        monthlyRentField.required = true;
      } else {
        monthlyRentSection.style.display = 'none';
        monthlyRentField.required = false;
        monthlyRentField.value = ''; // Clear the field when hidden
      }
    }

    // Listen for radio button changes
    if (totalCostYes) totalCostYes.addEventListener('change', toggleMonthlyRent);
    if (totalCostNo) totalCostNo.addEventListener('change', toggleMonthlyRent);

    // Form validation with visual feedback
    form.addEventListener('submit', function(e) {
      const requiredFields = form.querySelectorAll('[required]');
      let firstInvalidField = null;
      let isValid = true;

      // Remove previous error styling
      document.querySelectorAll('.form-section').forEach(section => {
        section.style.border = '';
        section.style.background = '';
      });

      requiredFields.forEach(field => {
        // Skip validation for hidden fields
        if (field.offsetParent === null) return;

        let isEmpty = false;
        if (field.type === 'radio') {
          const radioGroup = form.querySelectorAll(`input[name="${field.name}"]`);
          isEmpty = ![...radioGroup].some(radio => radio.checked);
        } else if (field.tagName === 'SELECT') {
          isEmpty = !field.value || field.value === '';
        } else {
          isEmpty = !field.value.trim();
        }

        if (isEmpty) {
          isValid = false;
          const section = field.closest('.form-section');
          if (section) {
            section.style.border = '2px solid #d32f2f';
            section.style.background = '#fff3f3';
            if (!firstInvalidField) firstInvalidField = section;
          }
        }
      });

      if (!isValid) {
        e.preventDefault();
        if (firstInvalidField) {
          firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        alert('Please fill in all required fields highlighted in red.');
      }
    });

    // Initialize monthly rent visibility on page load
    toggleMonthlyRent();
  });
</script>
