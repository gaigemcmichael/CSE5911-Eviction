<div class = "account">
    <!-- Main Content -->
    <div class="account-content">
        <div class="profile-section">
            <h1> <i class="fa-solid fa-user"></i> Personal Details</h1>
            <table class = "personal-details-table">
                <tr>
                    <th> <i class="fa-solid fa-id-badge"></i> Name</th>
                    <td> <%= @user.FName %> <%= @user.LName %> </td>
                </tr>
                <tr>
                    <th> <i class="fa-solid fa-envelope"></i> Email</th>
                    <td> <%= @user.Email %> </td>
                </tr>
                <tr>
                    <th> <i class="fa-solid fa-user-tag"></i> Role</th>
                    <td> <%= @user.Role %> </td>
                </tr>
                <% if @user.Role == "Tenant" %>
                  <tr>
                    <th> <i class="fa-solid fa-location-dot"></i> Address</th>
                    <td>
                      <!-- Current Address Display -->
                      <p><strong>Current:</strong> <%= @user.TenantAddress.presence || "Not provided" %></p>

                      <div class="form-section">
                        <!-- Form to Update Address -->
                        <%= form_with model: @user, url: account_path, method: :patch, local: true, id: "address-form" do |f| %>
                        <div class="input-field">
                          <i class="fa-solid fa-location-dot"></i>
                          <%= f.text_field :TenantAddress, class: "form-control", placeholder: "Enter new address" %>
                        </div>
                          <%= f.submit "Update Address" %>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% elsif @user.Role == "Landlord"%>
                    <tr>
                        <th> <i class="fa-solid fa-building"></i> Company</th>
                        <td> <%= @user.CompanyName %> </td>
                    </tr>
                <% end %>
            </table>
        </div>

        <div class="security-section">
            <h1> <i class="fa-solid fa-lock"></i> Password and Security</h1>
            <table class = "pass-security-table">
                <tr>
                    <th> <i class="fa-solid fa-key"></i> Password</th>
                    <td>
                      <%= form_with model: @user, url: account_path, method: :patch, local: true, id: "password-form" do |f| %>
                        <div class="form-section">
                          <div class="input-field">
                            <i class="fa-solid fa-lock"></i>
                            <%= f.password_field :password, placeholder: "New Password", id: "password" %><br>
                          </div>
                          <div class="input-field">
                            <i class="fa-solid fa-lock"></i>
                            <%= f.password_field :password_confirmation, placeholder: "Confirm Password", id: "password_confirmation" %><br>
                          </div>
                          <%= f.submit "Update Password" %>
                        </div>
                        <div id="password-error" class="text-danger mt-1" style="display: none;"></div>
                      <% end %>
                    </td>      
                </tr>
            </table>
        </div>

        <div class="sms-2fa-section">
          <h1> <i class="fa-solid fa-mobile-screen"></i> SMS Two-Factor Authentication</h1>
          
          <!-- Phone Number Card -->
          <div class="sms-2fa-card">
            <div class="card-header">
              <h3><i class="fa-solid fa-phone"></i> Phone Number</h3>
            </div>
            <div class="card-content">
              <div class="current-phone">
                <span class="label">Current:</span>
                <span class="value"><%= @user.phone_number.presence || "Not provided" %></span>
              </div>
              
              <%= form_with url: account_send_sms_verification_path, method: :post, local: true do |f| %>
                <div class="form-row">
                  <div class="input-group">
                    <i class="input-icon fa-solid fa-phone"></i>
                    <%= text_field_tag :phone_number, @user.phone_number, 
                        placeholder: "+1 (555) 555-0123", 
                        class: "form-input" %>
                  </div>
                  <%= submit_tag "Send Code", class: "btn btn-primary" %>
                </div>
              <% end %>
              
              <!-- Test SMS Section -->
              <div class="form-section">
                <p class="help-text">Test SMS delivery before enabling:</p>
                <%= form_with url: send_test_sms_path, method: :post, remote: true, id: "test-sms-form" do |f| %>
                  <div class="form-row">
                    <div class="input-group">
                      <i class="input-icon fa-solid fa-phone"></i>
                      <%= telephone_field_tag :phone_number, @user.phone_number, 
                          placeholder: "+1 (555) 555-0123", required: true, class: "form-input" %>
                    </div>
                    <%= f.submit "Send Test SMS", class: "btn btn-secondary" %>
                  </div>
                <% end %>
                <div id="test-sms-result" style="margin-top: 10px;"></div>
              </div>
            </div>
          </div>

          <!-- 2FA Status Card -->
          <div class="sms-2fa-card">
            <div class="card-header">
              <h3><i class="fa-solid fa-shield-halved"></i> Two-Factor Authentication</h3>
              <div class="status-badge">
                <% if @user.sms_2fa_enabled? %>
                  <span class="badge badge-enabled">
                    <i class="fa-solid fa-check-circle"></i> Enabled
                  </span>
                <% else %>
                  <span class="badge badge-disabled">
                    <i class="fa-solid fa-exclamation-triangle"></i> Disabled
                  </span>
                <% end %>
              </div>
            </div>
            <div class="card-content">
              <% if @user.sms_2fa_enabled? %>
                <!-- Disable Options -->
                <div class="disable-section">
                  <!-- Password Method -->
                  <div class="disable-method">
                    <h4><i class="fa-solid fa-key"></i> Disable with Password</h4>
                    <%= form_with url: account_disable_sms_2fa_path, method: :post, local: true do |f| %>
                      <div class="form-row">
                        <div class="input-group">
                          <i class="input-icon fa-solid fa-lock"></i>
                          <%= password_field_tag :password, nil, 
                              placeholder: "Confirm password", 
                              class: "form-input" %>
                        </div>
                        <%= submit_tag "Disable", class: "btn btn-danger" %>
                      </div>
                    <% end %>
                  </div>

                  <!-- SMS Code Method -->
                  <div class="disable-method">
                    <h4><i class="fa-solid fa-sms"></i> Disable with SMS Code</h4>
                    <p class="help-text">Can't remember your password? Use a verification code sent to your phone.</p>
                    <%= form_with url: account_disable_sms_2fa_path, method: :post, local: true do |f| %>
                      <div class="form-row">
                        <div class="input-group">
                          <i class="input-icon fa-solid fa-hashtag"></i>
                          <%= text_field_tag :sms_code, nil, 
                              placeholder: "6-digit code", 
                              class: "form-input code-input" %>
                        </div>
                        <%= submit_tag "Disable", class: "btn btn-danger" %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% else %>
                <!-- Enable Section -->
                <div class="enable-section">
                  <h4><i class="fa-solid fa-shield-check"></i> Enable Two-Factor Authentication</h4>
                  <p class="help-text">Enter the verification code sent to your phone number.</p>
                  <%= form_with url: account_enable_sms_2fa_path, method: :post, local: true do |f| %>
                    <div class="form-row">
                      <div class="input-group">
                        <i class="input-icon fa-solid fa-hashtag"></i>
                        <%= text_field_tag :sms_code, nil, 
                            placeholder: "6-digit code", 
                            class: "form-input code-input" %>
                      </div>
                      <%= submit_tag "Enable 2FA", class: "btn btn-success" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <% if @user.Role == "Mediator" %>
            <!-- Mediator Availability -->
            <div class="profile-section">
                <h1> <i class="fa-solid fa-user"></i> Mediator Availability</h1>
                <table class = "personal-details-table">
                    <tr>
                        <th>Are you available for Mediation? </th>
                        <td>
                        <%= form_with model: @user, url: account_path, method: :patch, local: true do |f| %>
                          <%= f.fields_for :mediator do |m| %>
                            <% status_text = @user.mediator.Available ? "Available" : "Not Available" %>
                            <% status_class = @user.mediator.Available ? "status-available" : "status-unavailable" %>
                            <p>
                              <strong>Status: 
                                <span class="availability-badge <%= status_class %>">
                                  <%= status_text %>
                                </span>
                              </strong>
                            </p>
                            <div class="form-section">
                              <div class="checkbox-inline">
                                <%= m.check_box :Available, class: "form-check-input", id: "availableCheckbox" %>
                                <%= m.label :Available, "Currently Available", class: "form-check-label", for: "availableCheckbox" %>
                              </div>
                      
                              <p></p> <!-- Space -->
                              <%= f.submit "Update Availability" %>
                            </div>
                          <% end %>
                        <% end %>
                      </td>
                    </tr>
                </table>
            </div>
        <% end %>
    </div>
</div>

<%# Password Confirmation Error Control #%>

<script>
  document.addEventListener("turbo:load", function () {
    const form = document.getElementById("password-form");
    const password = document.getElementById("password");
    const confirm = document.getElementById("password_confirmation");
    const errorBox = document.getElementById("password-error");

    if (!form || !password || !confirm || !errorBox) return;

    function checkMatch() {
      if (password.value !== confirm.value) {
        errorBox.textContent = "⚠️Passwords do not match.";
        errorBox.style.display = "block";
        return false;
      } else {
        errorBox.textContent = "";
        errorBox.style.display = "none";
        return true;
      }
    }

    password.addEventListener("input", checkMatch);
    confirm.addEventListener("input", checkMatch);

    form.addEventListener("submit", function (event) {
      if (!checkMatch()) {
        event.preventDefault();
      }
    });
  });

  // SMS Test functionality
  document.addEventListener("turbo:load", function () {
    const testForm = document.getElementById("test-sms-form");
    const resultDiv = document.getElementById("test-sms-result");
    
    if (testForm && resultDiv) {
      testForm.addEventListener("ajax:success", function(event) {
        const response = event.detail[0];
        if (response.success) {
          resultDiv.innerHTML = '<p style="color: green;"><i class="fa-solid fa-check"></i> ' + response.message + '</p>';
        } else {
          resultDiv.innerHTML = '<p style="color: red;"><i class="fa-solid fa-exclamation"></i> ' + response.error + '</p>';
        }
      });
      
      testForm.addEventListener("ajax:error", function(event) {
        resultDiv.innerHTML = '<p style="color: red;"><i class="fa-solid fa-exclamation"></i> Failed to send test SMS</p>';
      });
    }
  });
</script>