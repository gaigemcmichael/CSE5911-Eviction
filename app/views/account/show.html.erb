<div class="signup-container">
  <div style="max-width: 900px; width: 90%; margin: 0 auto; padding: 20px 0;">
    <h1 style="margin: 0 0 6px 0; font-size: 28px; color: #102a4d; text-align: center;"><i class="fa-solid fa-user-circle"></i> My Account</h1>
    <h2 style="font-size: 16px; color: #2b556f; font-weight: 400; margin-top: 0; margin-bottom: 32px; text-align: center;">Manage your personal information and security settings</h2>

    <!-- Personal Details Card -->
    <div class="account-card" style="margin-bottom: 24px;">
      <div class="card-header">
        <h2><i class="fa-solid fa-user"></i> Personal Details</h2>
      </div>
      <div class="card-body">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">
              <i class="fa-solid fa-id-badge"></i> Name
            </div>
            <div class="info-value"><%= @user.FName %> <%= @user.LName %></div>
          </div>

          <div class="info-item">
            <div class="info-label">
              <i class="fa-solid fa-envelope"></i> Email
            </div>
            <div class="info-value"><%= @user.Email %></div>
          </div>

          <div class="info-item">
            <div class="info-label">
              <i class="fa-solid fa-phone"></i> Phone Number
            </div>
            <div class="info-value"><%= @user.PhoneNumber.presence || "Not provided" %></div>
          </div>

          <div class="info-item">
            <div class="info-label">
              <i class="fa-solid fa-user-tag"></i> Role
            </div>
            <div class="info-value"><%= @user.Role %></div>
          </div>

        <% if @user.Role == "Tenant" %>
          <div class="info-item">
            <div class="info-label">
              <i class="fa-solid fa-location-dot"></i> Address
            </div>
            <div class="info-value"><%= @user.TenantAddress.presence || "Not provided" %></div>
          </div>
        </div>

        <div class="form-section-card">
          <div class="info-label" style="margin-bottom: 1rem;">
            <i class="fa-solid fa-edit"></i> Update Address
          </div>
          <%= form_with model: @user, url: account_path, method: :patch, local: true, id: "address-form", class: "account-form" do |f| %>
            <%= f.text_field :TenantAddress, class: "form-input-simple", placeholder: "Enter new address" %>
            <%= f.submit "Update Address", class: "btn-primary" %>
          <% end %>
        </div>
        <% else %>
        </div>
      </div>
    </div>

    <!-- Password & Security Card -->
    <div class="account-card" style="margin-bottom: 24px;">
      <div class="card-header">
        <h2><i class="fa-solid fa-lock"></i> Password & Security</h2>
      </div>
      <div class="card-body">
        <div class="form-section-card">
          <div class="info-label" style="margin-bottom: 1rem;">
            <i class="fa-solid fa-key"></i> Change Password
          </div>
          <%= form_with model: @user, url: account_path, method: :patch, local: true, id: "password-form", class: "account-form" do |f| %>
            <%= f.password_field :password, class: "form-input-simple", placeholder: "New Password", id: "password" %>
            <%= f.password_field :password_confirmation, class: "form-input-simple", placeholder: "Confirm Password", id: "password_confirmation" %>
            <div id="password-error" class="text-danger mt-1" style="display: none; margin-bottom: 1rem;"></div>
            <%= f.submit "Update Password", class: "btn-primary" %>
          <% end %>
        </div>

        <div class="form-section-card" style="margin-top: 2rem;">
          <div class="info-label" style="margin-bottom: 1rem;">
            <i class="fa-solid fa-mobile-screen"></i> Two-Factor Authentication
          </div>
          
          <% if @user.two_factor_enabled? %>
            <div class="status-display" style="margin-bottom: 1rem;">
              <span class="availability-badge status-available" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: #d1fae5; color: #065f46; font-weight: 600;">
                <i class="fa-solid fa-circle-check"></i> Enabled
              </span>
              <p style="margin-top: 0.75rem; color: #64748b;"><strong>Phone:</strong> <%= @user.format_phone_for_display %></p>
            </div>
            
            <%= form_with model: @user, url: account_path, method: :patch, local: true, class: "account-form" do |f| %>
              <%= f.telephone_field :phone_number, 
                  value: @user.phone_number, 
                  placeholder: "Update phone number (e.g., +15551234567)", 
                  class: "form-input-simple" %>
              <small class="form-text" style="display: block; margin-bottom: 0.75rem; color: #64748b;">Include country code (e.g., +1 for US)</small>
              <%= f.submit "Update Phone Number", class: "btn-primary", style: "margin-bottom: 0.75rem;", data: { confirm: "A verification code will be sent to the new phone number. Continue?" } %>
            <% end %>
            
            <%= form_with model: @user, url: account_path, method: :patch, local: true, class: "account-form" do |f| %>
              <%= f.hidden_field :two_factor_enabled, value: false %>
              <%= f.submit "Disable 2FA", class: "btn-danger", data: { confirm: "Are you sure you want to disable two-factor authentication?" } %>
            <% end %>
          <% else %>
            <div class="status-display" style="margin-bottom: 1rem;">
              <span class="availability-badge status-unavailable" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 8px; background: #fee2e2; color: #991b1b; font-weight: 600;">
                <i class="fa-solid fa-circle-xmark"></i> Disabled
              </span>
              <p style="margin-top: 0.75rem; color: #64748b;">Add an extra layer of security to your account with SMS verification.</p>
            </div>
            
            <%= form_with model: @user, url: account_path, method: :patch, local: true, class: "account-form" do |f| %>
              <%= f.telephone_field :phone_number, 
                  value: @user.phone_number, 
                  placeholder: "Enter phone number (e.g., +15551234567)", 
                  class: "form-input-simple" %>
              <small class="form-text" style="display: block; margin-bottom: 0.75rem; color: #64748b;">Include country code (e.g., +1 for US)</small>
              <%= f.hidden_field :two_factor_enabled, value: true %>
              <%= f.submit "Enable 2FA", class: "btn-primary", data: { confirm: "A verification code will be sent to this phone number. Continue?" } %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <% end %>

    <% if @user.Role == "Mediator" %>
      <!-- Mediator Availability Card -->
      <div class="account-card" style="margin-bottom: 24px;">
        <div class="card-header">
          <h2><i class="fa-solid fa-calendar-check"></i> Mediator Availability</h2>
        </div>
        <div class="card-body">
          <%= form_with model: @user, url: account_path, method: :patch, local: true, class: "account-form" do |f| %>
            <%= f.fields_for :mediator do |m| %>
              <div class="info-label">
                Current Status
              </div>
              <% status_text = @user.mediator.Available ? "Available" : "Not Available" %>
              <% status_class = @user.mediator.Available ? "status-available" : "status-unavailable" %>
              <div class="availability-badge <%= status_class %>">
                <i class="fa-solid <%= @user.mediator.Available ? 'fa-circle-check' : 'fa-circle-xmark' %>"></i>
                <%= status_text %>
              </div>

              <div class="checkbox-group">
                <%= m.check_box :Available, class: "form-checkbox", id: "availableCheckbox" %>
                <%= m.label :Available, "I am currently available for mediation", class: "checkbox-label", for: "availableCheckbox" %>
              </div>

              <%= f.submit "Update Availability", class: "btn-primary" %>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%# Password Confirmation Error Control #%>

<script>
  document.addEventListener("turbo:load", function () {
    const form = document.getElementById("password-form");
    const password = document.getElementById("password");
    const confirm = document.getElementById("password_confirmation");
    const errorBox = document.getElementById("password-error");

    if (!form || !password || !confirm || !errorBox) return;

    function checkMatch() {
      if (password.value !== confirm.value) {
        errorBox.textContent = "⚠️Passwords do not match.";
        errorBox.style.display = "block";
        return false;
      } else {
        errorBox.textContent = "";
        errorBox.style.display = "none";
        return true;
      }
    }

    password.addEventListener("input", checkMatch);
    confirm.addEventListener("input", checkMatch);

    form.addEventListener("submit", function (event) {
      if (!checkMatch()) {
        event.preventDefault();
      }
    });
  });
</script>