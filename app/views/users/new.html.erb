<!-- Sign Up Page -->
<div class="signup-page">
  <div class="signup-title">Eviction Mediation</div>
  
  <div class="signup-container">
    <!-- Banner -->
    <div class="signup-banner">
      <h1>Create your account</h1>
      <p>Join our platform to resolve rental disputes effectively</p>
    </div>

    <div class="signup-card">
      <h2> <i class="fa-solid fa-user-plus"></i> Sign Up</h2>
      <p class="signup-text"> Let's create your account. </p>

    <%= form_with model: @user, url: signup_path, local: true, data: { turbo: false }, class: "signup-form" do |f| %>
      <%# Error handling display #%>
      <% if @user.errors.any? %>
        <div class="error-summary">
          <h4>The following errors occured: </h4>
            <% @user.errors.full_messages.each do |msg| %>
              <span><%= msg %></span>
            <% end %>
        </div>
      <% end %>
      <!-- First Name -->
      <div class="input-group">
        <label for="FName">First Name</label>
        <div class="input-field">
          <i class="fa-solid fa-user"></i>
          <%= f.text_field :FName, placeholder: "Enter your first name", required: true, class: "signup-input" %>
        </div>
      </div>

      <!-- Last Name -->
      <div class="input-group">
        <label for="LName">Last Name</label>
        <div class="input-field">
          <i class="fa-solid fa-user"></i>
          <%= f.text_field :LName, placeholder: "Enter your last name", required: true, class: "signup-input" %>
        </div>
      </div>

      <!-- Email -->
      <div class="input-group">
        <label for="Email">Email</label>
        <div class="input-field">
          <i class="fa-solid fa-envelope"></i>
          <%= f.email_field :Email, placeholder: "youremail@example.com", required: true, class: "signup-input" %>
        </div>
        <% if @user.errors[:Email].any? %>
          <div class="error-text"><%= @user.errors[:Email].first %></div>
        <% end %>
      </div>

      <!-- Password -->
      <div class="input-group">
        <label for="Password">Password</label>
        <div class="input-field">
          <i class="fa-solid fa-lock"></i>
          <%= f.password_field :password, placeholder: "Create a password", required: true, class: "signup-input" %>
        </div>
        <% if @user.errors[:password].any? %>
          <div class="error-text"><%= @user.errors[:password].first %></div>
        <% end %>
      </div>

      <!-- Password Confirmation -->
      <div class="input-group">
        <label for="PasswordConfirmation">Confirm Password</label>
        <div class="input-field">
          <i class="fa-solid fa-lock"></i>
          <%= f.password_field :password_confirmation, placeholder: "Confirm your password", required: true, class: "signup-input" %>
        </div>
        <% if @user.errors[:password_confirmation].any? %>
          <div class="error-text"><%= @user.errors[:password_confirmation].first %></div>
        <% end %>
      </div>

      <!-- Role Selection -->
      <div class="role-selection">
        <p>Please select your role:</p>
        <label class="role-option">
          <%= f.radio_button :Role, "Tenant", id: "role_tenant", class: "signup-radio" %>
          Tenant
        </label>
        <label class="role-option">
          <%= f.radio_button :Role, "Landlord", id: "role_landlord", class: "signup-radio" %>
          Landlord
        </label>
      </div>

      <!-- Address Field -->
      <div id="address-field" class="conditional-field">
        <div class="input-group">
          <label for="TenantAddress">Address</label>
          <div class="input-field">
            <i class="fa-solid fa-map-marker-alt"></i>
            <%= f.text_field :TenantAddress, placeholder: "Enter your address", class: "signup-input" %>
          </div>
        </div>
      </div>

      <!-- Company Name Field -->
      <div id="company-field" class="conditional-field">
        <div class="input-group">
          <label for="CompanyName">Company Name</label>
          <div class="input-field">
            <i class="fa-solid fa-building"></i>
            <%= f.text_field :CompanyName, placeholder: "Enter your company name", class: "signup-input" %>
          </div>
        </div>
      </div>

      <!-- Phone Number (Always Visible) -->
      <div class="input-group">
        <label for="PhoneNumber">Phone Number</label>
        <div class="input-field">
          <i class="fa-solid fa-phone"></i>
          <%= f.telephone_field :PhoneNumber, placeholder: "Enter your phone number", required: true, class: "signup-input" %>
        </div>
      </div>

      <!-- Disclaimer -->
      <p style="color: #102a4d; font-weight: 600; margin-bottom: 12px; font-size: 15px;">
        <i class="fa-solid fa-info-circle"></i> Please click "Legal Disclaimer" below to read the full terms before continuing.
      </p>
      <div class="disclaimer">
          <label class="custom-checkbox">
              <%= f.check_box :ProfileDisclaimer, { required: true }, 'yes', 'no' %>
              <span class="checkmark"></span>
              <span class="disclaimer-text">
                  I have read and agree to the 
                  <label for="toggleModal" class="disclaimer-link">Legal Disclaimer</label>
              </span>
          </label>

          <!-- Display error message if the disclaimer is not checked -->
          <% if @user.errors[:ProfileDisclaimer].any? %>
              <div class="error-text"><%= @user.errors[:ProfileDisclaimer].first %></div>
          <% end %>
          <div id="terms-error" class="error-text" style="display: none;">You must open and read the Legal Disclaimer before signing up</div>
      </div>

      <!-- Hidden inputs for tracking -->
      <input type="hidden" id="termsOpened" value="false">
      
      <!-- Hidden Checkbox to Toggle Modal -->
      <input type="checkbox" id="toggleModal" class="toggle-checkbox">

      <!-- Modal Popup -->
      <div class="modal-popup">
        <div class="popup-content">
          <!-- Clicking this label will uncheck the checkbox, closing the modal -->
          <label for="toggleModal" class="close-popup">&times;</label>
          <h4>Legal Disclaimer</h4>
          <p style="text-align: center;">Please read this information before using this platform.</p>
          <p style="text-align: center;">This platform is designed to help landlords and tenants participate in the existing process, learn about mediation, and communicate with each other. It also allows both sides to negotiate with support from a trained mediator if they opt for that option. <strong>The information provided is for mediation and negotiation purposes only.</strong></p>
          <p><strong>1. Not Legal Advice.</strong></p>
          <p>This platform does not give legal advice to any user. Nothing you read or discuss here should be taken as legal advice about your specific situation. <strong>Using this platform does not create a lawyer-client relationship.</strong> If you need legal advice, you should speak with an attorney or a legal aid organization.</p>
          <p><strong>2. No Guarantees of Results.</strong></p>
          <p>This <strong>platform cannot guarantee any specific outcome</strong>. We cannot promise that mediation will be successful or that your negotiation will reach an agreement. Results depend on your situation and the actions of each party.</p>
          <p><strong>3. Role of the Mediator.</strong></p>
          <p>Any mediator using this platform is here to <strong>help support communication</strong>, but they do not represent either party and cannot provide legal advice. Mediators do not make decisions for you and do not have the power to force an agreement.</p>
          <p><strong>4. Confidentiality.</strong></p>
          <p>Communications between users through this platform are <strong>not confidential</strong> unless a mediator formally joins the dispute. Mediators involved in cases are legally bound to confidentiality, but communications outside the mediation process are not protected.</p>
          <p><strong>5. Enforceability of Agreements.</strong></p>
          <p>Any agreement reached through this platform is <strong>not legally enforceable</strong> unless the final written agreement is signed by all parties. Talking through the platform or expressing agreement in the chat does not create a binding contract. A signed written document is required.</p>
          <p><strong>6. Links to Outside Services.</strong></p>
          <p>This platform may share links to outside community services such as rental help, mental health referrals, or other support programs. These organizations are <strong>not run by this platform or the court</strong>. We do not control them, and we are <strong>not responsible</strong> for their actions, information, or decisions.</p>
          <p><strong>7. Information May Change.</strong></p>
          <p>Laws, court rules, and procedures can change. We work to keep information accurate, but we <strong>cannot promise</strong> that everything is always current or applies to every situation.</p>
          <p><strong>8. User Responsibility.</strong></p>
          <p>You are responsible for your own choices, messages, and court deadlines. The platform and its mediators are here to support communication, but <strong>cannot act on your behalf</strong> or make decisions for you.</p>
          <p><strong>By using this platform, you acknowledge that you have read, understood, and accept the terms of this disclaimer.</strong></p>
          <div style="text-align: center; margin-top: 20px;">
            <button type="button" id="agreeButton" class="btn-primary" style="padding: 12px 40px; font-size: 16px;">I Agree</button>
          </div>
        </div>
      </div>

      <!-- Sign Up Button -->
      <%= f.submit "Sign Up", class: "signup-btn" %>
    <% end %>

    <p class="signup-text">Already have an account? 
      <%= link_to "Log in", root_path, class: "signup-link" %></p>
    </div>

    <!-- Features Section -->
    <div class="features">
      <div class="features-grid">
        <div class="feature">
          <i class="fa-solid fa-scale-balanced"></i>
          <p>Early Mediation</p>
        </div>
        <div class="feature">
          <i class="fa-solid fa-comments"></i>
          <p>Text-Based Communication</p>
        </div>
        <div class="feature">
          <i class="fa-solid fa-file-signature"></i>
          <p>Digital Agreements</p>
        </div>
        <div class="feature">
          <i class="fa-solid fa-calculator"></i>
          <p>Payment Planning</p>
        </div>
      </div>
      <p>Communicate early. Avoid court. Find fair solutions.</p>
    </div>
  </div>
</div>

<script>
  function toggleFields() {
    const tenantRadio = document.getElementById("role_tenant");
    const landlordRadio = document.getElementById("role_landlord");
    const addressField = document.getElementById("address-field");
    const companyField = document.getElementById("company-field");

    if (!tenantRadio || !landlordRadio || !addressField || !companyField) return;

    if (tenantRadio.checked) {
      // If signing up as tenant, show address field, hide company name field
      addressField.style.display = "block";
      addressField.querySelector("input").required = true;
      companyField.style.display = "none";
      companyField.querySelector("input").required = false;
    } else if (landlordRadio.checked) {
      // If signing up as landlord, show company name field, hide address field
      addressField.style.display = "none";
      addressField.querySelector("input").required = false;
      companyField.style.display = "block";
      companyField.querySelector("input").required = false;
    } else {
      addressField.style.display = "none";
      companyField.style.display = "none";
    }
  }

  function setupTermsTracking() {
    const toggleModal = document.getElementById("toggleModal");
    const termsOpened = document.getElementById("termsOpened");
    const signupForm = document.querySelector(".signup-form");
    const termsError = document.getElementById("terms-error");
    const agreeButton = document.getElementById("agreeButton");
    const disclaimerCheckbox = document.getElementById("user_ProfileDisclaimer");

    // Track when modal is opened
    if (toggleModal) {
      toggleModal.addEventListener("change", function() {
        if (this.checked && termsOpened) {
          termsOpened.value = "true";
          if (termsError) termsError.style.display = "none";
        }
      });
    }

    // Handle I Agree button click
    if (agreeButton) {
      agreeButton.addEventListener("click", function() {
        // Mark terms as opened
        if (termsOpened) termsOpened.value = "true";
        // Check the disclaimer checkbox
        if (disclaimerCheckbox) disclaimerCheckbox.checked = true;
        // Close the modal
        if (toggleModal) toggleModal.checked = false;
        // Hide error if visible
        if (termsError) termsError.style.display = "none";
      });
    }

    // Validate before form submission
    if (signupForm) {
      signupForm.addEventListener("submit", function(e) {
        if (termsOpened && termsOpened.value !== "true") {
          e.preventDefault();
          if (termsError) {
            termsError.style.display = "block";
            termsError.scrollIntoView({ behavior: "smooth", block: "center" });
          }
          return false;
        }
      });
    }
  }

  function setupToggleHandlers() {
    const tenantRadio = document.getElementById("role_tenant");
    const landlordRadio = document.getElementById("role_landlord");

    if (tenantRadio) tenantRadio.addEventListener("change", toggleFields);
    if (landlordRadio) landlordRadio.addEventListener("change", toggleFields);

    toggleFields(); // initial setup
    setupTermsTracking(); // setup terms validation
  }

  document.addEventListener("DOMContentLoaded", setupToggleHandlers);
  document.addEventListener("turbo:load", setupToggleHandlers); // for Turbo
</script>
