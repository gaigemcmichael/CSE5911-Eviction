<div class="document-view-container">
  <% back_path = case @user.Role
    when "Mediator"
      third_party_mediations_path
    else
      documents_path
  end %>

  <%= link_to back_path, class: "back-link" do %>
    <i class="fa-solid fa-arrow-left"></i> Back to Documents
  <% end %>

  <div class="document-header-card">
    <div class="header-content">
      <h1><%= @file.FileName %></h1>
      <div class="document-actions">
        <%= link_to download_file_path(@file.FileID), target: "_blank", class: "btn-document-action" do %>
          <i class="fa-solid fa-download"></i> Download
        <% end %>
      </div>
    </div>
  </div>

  <% if @conversation && @landlord && @tenant %>
    <!-- Signature Status Card -->
    <div class="signature-status-card">
      <h3>Signature Status</h3>
      <div class="signature-grid">
        <div class="signature-party">
          <div class="party-label">Landlord</div>
          <div class="party-name"><%= @landlord.FName %> <%= @landlord.LName %></div>
          <% if @file.LandlordSignature %>
            <div class="signature-status signed">
              <i class="fa-solid fa-check-circle"></i> Signed
            </div>
            <% if @file.LandlordSignedAt %>
              <div class="signature-timestamp"><%= @file.LandlordSignedAt.strftime("%B %d, %Y at %I:%M %p") %></div>
            <% end %>
          <% else %>
            <div class="signature-status pending">
              <i class="fa-regular fa-circle"></i> Awaiting signature
            </div>
          <% end %>
        </div>
        <div class="signature-party">
          <div class="party-label">Tenant</div>
          <div class="party-name"><%= @tenant.FName %> <%= @tenant.LName %></div>
          <% if @file.TenantSignature %>
            <div class="signature-status signed">
              <i class="fa-solid fa-check-circle"></i> Signed
            </div>
            <% if @file.TenantSignedAt %>
              <div class="signature-timestamp"><%= @file.TenantSignedAt.strftime("%B %d, %Y at %I:%M %p") %></div>
            <% end %>
          <% else %>
            <div class="signature-status pending">
              <i class="fa-regular fa-circle"></i> Awaiting signature
            </div>
          <% end %>
        </div>
      </div>

      <% if @file.LandlordSignature && @file.TenantSignature %>
        <div class="completion-banner">
          <i class="fa-solid fa-check-circle"></i>
          <strong>Document Fully Executed</strong> - Both parties have signed this agreement.
        </div>
      <% end %>
    </div>

    <!-- Signing Form (only show if user hasn't signed yet) -->
    <% if @user_role_in_conversation == "landlord" && !@file.LandlordSignature %>
      <div class="signing-card">
        <h3><i class="fa-solid fa-pen-to-square"></i> Sign This Document</h3>
        <p class="signing-description">By signing below, you confirm that you agree to the terms outlined in this document.</p>
        <%= form_with url: apply_signature_document_path(@file.FileID), method: :post, local: true, class: "signature-form" do |form| %>
          <div class="form-group">
            <%= form.label :signature_name, "Your Full Name", class: "form-label" %>
            <%= form.text_field :signature_name, value: "#{@landlord.FName} #{@landlord.LName}", class: "form-input", required: true %>
            <small class="form-hint">Your signature will be recorded as: <strong>/s/ [Your Name]</strong></small>
          </div>
          <div class="form-actions">
            <%= form.submit "Sign Document", class: "btn-sign" %>
          </div>
        <% end %>
      </div>
    <% elsif @user_role_in_conversation == "tenant" && !@file.TenantSignature %>
      <div class="signing-card">
        <h3><i class="fa-solid fa-pen-to-square"></i> Sign This Document</h3>
        <p class="signing-description">By signing below, you confirm that you agree to the terms outlined in this document.</p>
        <%= form_with url: apply_signature_document_path(@file.FileID), method: :post, local: true, class: "signature-form" do |form| %>
          <div class="form-group">
            <%= form.label :signature_name, "Your Full Name", class: "form-label" %>
            <%= form.text_field :signature_name, value: "#{@tenant.FName} #{@tenant.LName}", class: "form-input", required: true %>
            <small class="form-hint">Your signature will be recorded as: <strong>/s/ [Your Name]</strong></small>
          </div>
          <div class="form-actions">
            <%= form.submit "Sign Document", class: "btn-sign" %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>

  <div class="document-preview-card">
    <iframe src="<%= download_file_path(@file.FileID) %>" class="document-iframe">
      Your browser does not support iframes.
      <%= link_to "View Document", download_file_path(@file.FileID), target: "_blank", class: "fallback-link" %>
    </iframe>
  </div>
</div>

<% if @conversation %>
<script>
  (function() {
    const fileId = <%= @file.FileID %>;
    const cable = ActionCable.createConsumer();
    
    const subscription = cable.subscriptions.create(
      { channel: "DocumentSignatureChannel", file_id: fileId },
      {
        received(data) {
          if (data.type === 'signature_update') {
            // Update landlord signature status
            const signatureParties = document.querySelectorAll('.signature-party');
            if (signatureParties[0] && data.landlord_signature) {
              const landlordDiv = signatureParties[0];
              const statusDiv = landlordDiv.querySelector('.signature-status');
              if (statusDiv) {
                statusDiv.className = 'signature-status signed';
                statusDiv.innerHTML = '<i class="fa-solid fa-check-circle"></i> Signed';
                
                // Add timestamp if it doesn't exist
                let timestampDiv = landlordDiv.querySelector('.signature-timestamp');
                if (!timestampDiv && data.landlord_signed_at) {
                  timestampDiv = document.createElement('div');
                  timestampDiv.className = 'signature-timestamp';
                  timestampDiv.textContent = data.landlord_signed_at;
                  statusDiv.after(timestampDiv);
                }
              }
            }
            
            // Update tenant signature status
            if (signatureParties[1] && data.tenant_signature) {
              const tenantDiv = signatureParties[1];
              const statusDiv = tenantDiv.querySelector('.signature-status');
              if (statusDiv) {
                statusDiv.className = 'signature-status signed';
                statusDiv.innerHTML = '<i class="fa-solid fa-check-circle"></i> Signed';
                
                // Add timestamp if it doesn't exist
                let timestampDiv = tenantDiv.querySelector('.signature-timestamp');
                if (!timestampDiv && data.tenant_signed_at) {
                  timestampDiv = document.createElement('div');
                  timestampDiv.className = 'signature-timestamp';
                  timestampDiv.textContent = data.tenant_signed_at;
                  statusDiv.after(timestampDiv);
                }
              }
            }
            
            // Hide signing form if current user just signed
            const signingCard = document.querySelector('.signing-card');
            if (signingCard) {
              signingCard.remove();
            }
            
            // Show fully executed banner if both signed
            if (data.both_signed) {
              const statusCard = document.querySelector('.signature-status-card');
              const existingBanner = statusCard.querySelector('.completion-banner');
              if (!existingBanner) {
                const banner = document.createElement('div');
                banner.className = 'completion-banner';
                banner.innerHTML = '<i class="fa-solid fa-check-circle"></i><strong>Document Fully Executed</strong> - Both parties have signed this agreement.';
                statusCard.appendChild(banner);
              }
            }
          }
        }
      }
    );
  })();
</script>
<% end %>
